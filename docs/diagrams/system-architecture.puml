@startuml SystemArchitecture-TytoAlba
!define C4Context
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_WITH_LEGEND()

title System Architecture - TytoAlba Predictive Monitoring System

Person(captain, "Ship Captain", "Monitors fuel and route on vessel")
Person(fleetMgr, "Fleet Manager", "Manages fleet operations from office")
Person(admin, "System Admin", "Maintains system and ML models")

System_Boundary(vessel, "Vessel (On-board)") {
    Container(fuelSensor, "Fuel Sensors", "IoT Devices", "Ultrasonic fuel level sensors with digital output")
    Container(gpsSensor, "GPS Module", "IoT Devices", "Real-time positioning system")
    Container(edgeGateway, "Edge Gateway", "MQTT Client + Buffer", "Collects sensor data and publishes via MQTT")
}

System_Boundary(onprem, "On-Premise Server (PT Bahtera Adhiguna)") {

    System_Boundary(messaging, "Messaging Layer") {
        Container(mqttBroker, "MQTT Broker", "Eclipse Mosquitto", "Handles pub/sub messaging from vessels")
    }

    System_Boundary(dataLayer, "Data Layer") {
        ContainerDb(timescaleDB, "Time-Series Database", "PostgreSQL + TimescaleDB", "Stores sensor readings, predictions, ship data")
        ContainerDb(redisCache, "Cache Layer", "Redis", "Caches frequently accessed data and API responses")
    }

    System_Boundary(appLayer, "Application Layer") {
        Container(backendAPI, "Backend API", "Go (Golang)", "RESTful API for frontend, handles business logic")
        Container(mlService, "ML Service", "Python + FastAPI", "LSTM model inference service")
        Container(dataProcessor, "Data Processor", "Python Worker", "Validates, cleanses, and processes incoming sensor data")
    }

    System_Boundary(mlPipeline, "ML Pipeline") {
        Container(featureStore, "Feature Store", "Python + Pandas", "Preprocesses data for ML inference")
        Container(lstmModel, "LSTM Model", "TensorFlow/Keras", "Bi-LSTM with Attention for ETA & fuel prediction")
        Container(modelRegistry, "Model Registry", "MLflow", "Stores model versions and metadata")
    }

    System_Boundary(monitoring, "Monitoring & Logging") {
        Container(prometheus, "Metrics Collector", "Prometheus", "Collects system metrics")
        Container(grafana, "Monitoring Dashboard", "Grafana", "Visualizes system health and performance")
        Container(logAggregator, "Log Aggregator", "ELK Stack", "Centralized logging")
    }
}

System_Boundary(client, "Client Layer") {
    Container(webApp, "Web Application", "Vue.js 3 + TypeScript", "Interactive dashboard with map visualization")
    Container(mobileApp, "Mobile App (Future)", "React Native", "Mobile interface for captains")
}

System_Ext(weatherAPI, "Weather API", "External weather service (OpenWeatherMap)")
System_Ext(aisAPI, "AIS Data Source", "Marine traffic data provider")

' Vessel connections
Rel(fuelSensor, edgeGateway, "Sends fuel readings", "Serial/Modbus")
Rel(gpsSensor, edgeGateway, edgeGateway, "Sends GPS data", "NMEA 0183")
Rel(edgeGateway, mqttBroker, "Publishes sensor data", "MQTT over Cellular/Satellite")

' Data flow from MQTT
Rel(mqttBroker, dataProcessor, "Subscribes to topics", "MQTT")
Rel(dataProcessor, timescaleDB, "Writes validated data", "SQL")
Rel(dataProcessor, backendAPI, "Triggers events", "HTTP Webhook")

' API layer connections
Rel(backendAPI, timescaleDB, "Reads/Writes data", "PostgreSQL Protocol")
Rel(backendAPI, redisCache, "Caches responses", "Redis Protocol")
Rel(backendAPI, mlService, "Requests predictions", "HTTP/REST")

' ML Service connections
Rel(mlService, featureStore, "Fetches features", "Python API")
Rel(featureStore, timescaleDB, "Queries historical data", "SQL")
Rel(mlService, lstmModel, "Inference request", "TensorFlow Serving")
Rel(mlService, modelRegistry, "Loads model version", "MLflow API")

' External API connections
Rel(mlService, weatherAPI, "Fetches weather forecast", "HTTPS/REST")
Rel(mlService, aisAPI, "Fetches vessel traffic", "HTTPS/REST")

' Client connections
Rel(captain, webApp, "Views dashboard", "HTTPS")
Rel(fleetMgr, webApp, "Monitors fleet", "HTTPS")
Rel(admin, webApp, "Administers system", "HTTPS")
Rel(webApp, backendAPI, "API calls", "HTTPS/REST + WebSocket")

' Monitoring connections
Rel(backendAPI, prometheus, "Exports metrics", "Prometheus Exporter")
Rel(mlService, prometheus, "Exports metrics", "Prometheus Exporter")
Rel(mqttBroker, prometheus, "Exports metrics", "Prometheus Exporter")
Rel(prometheus, grafana, "Queries metrics", "PromQL")
Rel_Back(admin, grafana, "Views dashboards", "HTTPS")

' Logging
Rel(backendAPI, logAggregator, "Sends logs", "Logstash")
Rel(mlService, logAggregator, "Sends logs", "Logstash")
Rel(dataProcessor, logAggregator, "Sends logs", "Logstash")

SHOW_LEGEND()

note as NetworkNote
**Network Connectivity:**
- Vessel to Server: 4G/5G Cellular or Satellite (Iridium)
- Average bandwidth: 128-256 kbps
- MQTT QoS Level 1 (at least once delivery)
- Data buffering during connectivity loss
end note

note as SecurityNote
**Security Measures:**
- MQTT over TLS (port 8883)
- JWT authentication for API
- API rate limiting: 100 req/min
- Database encrypted at rest
- VPN for admin access
end note

@enduml
